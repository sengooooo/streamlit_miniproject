#!/usr/bin/env python
# coding: utf-8

# In[7]:


get_ipython().run_cell_magic('writefile', 'module/project1.py', 'import streamlit as st\nimport pandas as pd\nimport plotly.graph_objects as go\n\n# -----------------------------------------------------------------------------\n# 0. í˜ì´ì§€ ì„¤ì •\n# -----------------------------------------------------------------------------\nst.set_page_config(\n    page_title="ğŸ‘» GoStock - ë‚˜ë§Œì˜ ì‘ì€ ì£¼ì‹ ë¹„ì„œ",\n    layout="wide",\n    initial_sidebar_state="expanded"\n)\n\n# íƒ­ ìŠ¤íƒ€ì¼ CSS\nst.markdown("""\n<style>\n    .stTabs [data-baseweb="tab-list"] { gap: 2px; }\n    .stTabs [data-baseweb="tab"] {\n        height: 50px; white-space: pre-wrap; background-color: #f0f2f6;\n        border-radius: 4px 4px 0px 0px; gap: 1px;\n        padding-top: 10px; padding-bottom: 10px;\n        flex-grow: 1; text-align: center; font-size: 1.2rem; font-weight: 600;\n    }\n    .stTabs [aria-selected="true"] {\n        background-color: #ffffff; border-bottom: 2px solid #4e8cff; color: #4e8cff;\n    }\n</style>\n""", unsafe_allow_html=True)\n\n# -----------------------------------------------------------------------------\n# 1. ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬\n# -----------------------------------------------------------------------------\n@st.cache_data\ndef load_data():\n    fin_path = \'fin_info_final.csv\'\n    price_path = \'stock_re.csv\'\n\n    try:\n        df_fin = pd.read_csv(fin_path)\n        df_price = pd.read_csv(price_path, encoding=\'euc-kr\')\n    except FileNotFoundError:\n        return None, None\n\n    # [ì£¼ê°€ ë°ì´í„° ì „ì²˜ë¦¬]\n    df_price.columns = df_price.columns.str.strip()\n    \n    # ìˆ«ìí˜• ë³€í™˜ (ì‰¼í‘œ ì œê±°)\n    numeric_cols = [\'ì¢…ê°€\', \'ì‹œê°€\', \'ê³ ê°€\', \'ì €ê°€\', \'ê±°ë˜ëŸ‰\']\n    for col in numeric_cols:\n        if df_price[col].dtype == \'object\':\n            df_price[col] = df_price[col].astype(str).str.replace(\',\', \'\').astype(float)\n    \n    df_price[\'ë‚ ì§œ\'] = pd.to_datetime(df_price[\'ë‚ ì§œ\'])\n    df_price[\'íšŒì‚¬ì½”ë“œ\'] = df_price[\'íšŒì‚¬ì½”ë“œ\'].astype(str).str.zfill(6)\n    df_price = df_price.sort_values(by=[\'íšŒì‚¬ì½”ë“œ\', \'ë‚ ì§œ\']).reset_index(drop=True)\n    \n    # ì´ë™í‰ê· ì„  ê³„ì‚°\n    df_price[\'MA5\'] = df_price.groupby(\'íšŒì‚¬ì½”ë“œ\')[\'ì¢…ê°€\'].transform(lambda x: x.rolling(window=5).mean())\n    df_price[\'MA20\'] = df_price.groupby(\'íšŒì‚¬ì½”ë“œ\')[\'ì¢…ê°€\'].transform(lambda x: x.rolling(window=20).mean())\n    df_price[\'MA60\'] = df_price.groupby(\'íšŒì‚¬ì½”ë“œ\')[\'ì¢…ê°€\'].transform(lambda x: x.rolling(window=60).mean())\n\n    return df_fin, df_price\n\ndf_info_origin, df_money = load_data()\n\nif df_info_origin is None or df_money is None:\n    st.error("ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")\n    st.stop()\n\n# -----------------------------------------------------------------------------\n# 2. ì‹œì¥ í‰ê· (ë§ˆì§€ë§‰ í–‰) ë¶„ë¦¬ + ì¢…ëª© ê¸°ë³¸ ì •ë³´ ì¤€ë¹„\n# -----------------------------------------------------------------------------\n# ë§ˆì§€ë§‰ í–‰ì´ \'ì¢…ëª© í‰ê· \'\nmarket_mean_series = df_info_origin.iloc[-1]\n\n# ì‹¤ì œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ë§ˆì§€ë§‰ í–‰ ì œì™¸)\ndf_info = df_info_origin.iloc[:-1].copy()\n\n# íšŒì‚¬ì½”ë“œ ë§¤í•‘\ncode_map = df_money[[\'ì‚¬ëª…\', \'íšŒì‚¬ì½”ë“œ\']].drop_duplicates().set_index(\'ì‚¬ëª…\')[\'íšŒì‚¬ì½”ë“œ\'].to_dict()\nif \'íšŒì‚¬ì½”ë“œ\' not in df_info.columns:\n    # íšŒì‚¬ì½”ë“œ ë§¤í•‘ ë³´ì™„\n    df_info[\'íšŒì‚¬ì½”ë“œ\'] = df_info[\'ì‚¬ëª…\'].map(code_map)\n    df_info[\'íšŒì‚¬ì½”ë“œ\'] = df_info[\'íšŒì‚¬ì½”ë“œ\'].fillna("000000")  # ê¸°ë³¸ê°’ ë„£ê¸°\n\n\n# -----------------------------------------------------------------------------\n# 3. ë©”ì¸ í—¤ë”\n# -----------------------------------------------------------------------------\nst.title("ğŸ‘» GoStock")\nst.caption("ë‚˜ë§Œì˜ ì‘ê³  ì†Œì¤‘í•œ ì£¼ì‹ ë¹„ì„œ")\n\n# -----------------------------------------------------------------------------\n# 4. ì¢…ëª© í•„í„° ì„¤ì • & ë¦¬ìŠ¤íŠ¸\n# -----------------------------------------------------------------------------\nst.markdown("### ğŸ” ì¢…ëª© í•„í„°")  # ë¬¸êµ¬ ìˆ˜ì •\n\ngood_filter = st.checkbox("ğŸŸ¢ ì €í‰ê°€ ì¢…ëª©", value=False)  # ë„¤ì´ë° ìˆ˜ì • >> (ìš°ëŸ‰ì£¼ë§Œ ë³´ê¸° > ì €í‰ê°€ ì¢…ëª©)\n\nif good_filter:\n    filtered_df = df_info[\n        (df_info["PER(ë°°)"] >= 0) &\n        (df_info["PBR(ë°°)"] >= 0) &\n        (df_info["PER(ë°°)"] <= 10) &\n        (df_info["PBR(ë°°)"] <= 1)\n    ].copy()\nelse:\n    filtered_df = df_info.copy()\n\nst.markdown("#### ğŸ“‹ ëŒ€ìƒ ì¢…ëª© ë¦¬ìŠ¤íŠ¸")  # ë¬¸êµ¬ ìˆ˜ì •\nshow_cols = ["ì‚¬ëª…", "PER(ë°°)", "PBR(ë°°)", "ROE(%)", "ë§¤ì¶œì•¡ì¦ê°€ìœ¨", "ë¶€ì±„ë¹„ìœ¨", "ë°°ë‹¹ìˆ˜ìµë¥ "]   # ì»¬ëŸ¼ ìˆœì„œ ì¡°ì •\n# show_cols = ["ì‚¬ëª…", "PER(ë°°)", "PBR(ë°°)", "ROE(%)", "ë°°ë‹¹ìˆ˜ìµë¥ "]\n\n# (ì¶”ê°€)ì¸ë±ìŠ¤ë¥¼ 1ë¶€í„° ì‹œì‘í•˜ë„ë¡ ë³€ê²½\nfiltered_df = filtered_df.reset_index(drop=True)\nfiltered_df.index = filtered_df.index + 1\nfiltered_df = filtered_df.rename_axis("ìˆœë²ˆ")  \n\nst.dataframe(filtered_df[show_cols], use_container_width=True)\n\n# -----------------------------------------------------------------------------\n# 5. ë¶„ì„í•  ì¢…ëª© ì„ íƒ\n# -----------------------------------------------------------------------------\nst.markdown("### ğŸ“Œ ë¶„ì„í•  ì¢…ëª© ì„ íƒ")\n\nif filtered_df.empty:\n    st.error("âš ï¸ í˜„ì¬ í•„í„° ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ ì£¼ì„¸ìš”.")\n    st.stop()\n\nfiltered_df = filtered_df.dropna(subset=["íšŒì‚¬ì½”ë“œ"])\nfiltered_labels = filtered_df.apply(\n    lambda x: f"{x[\'ì‚¬ëª…\']} ({str(x[\'íšŒì‚¬ì½”ë“œ\']).zfill(6)})",\n    axis=1\n).tolist()\n\nselected_label = st.selectbox("ğŸ” ì¢…ëª© ì„ íƒ", filtered_labels, index=0)\nselected_company = selected_label.split(" (")[0]\n\n# ì„ íƒëœ ì¢…ëª© ì •ë³´ & ì£¼ê°€ ë°ì´í„°\ncompany_info = filtered_df[filtered_df[\'ì‚¬ëª…\'] == selected_company].iloc[0]\ncompany_money = df_money[df_money[\'ì‚¬ëª…\'] == selected_company].sort_values(\'ë‚ ì§œ\')\n\nif company_money.empty:\n    st.error("í•´ë‹¹ ì¢…ëª©ì˜ ì£¼ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")\n    st.stop()\n\n# -----------------------------------------------------------------------------\n# 6. ìƒë‹¨ í•µì‹¬ ìš”ì•½ (í˜„ì¬ ì£¼ê°€ / PER / PBR / ROE)\n# -----------------------------------------------------------------------------\nlast_row = company_money.iloc[-1]\nlast_price = last_row[\'ì¢…ê°€\']\nprev_price = company_money.iloc[-2][\'ì¢…ê°€\'] if len(company_money) > 1 else last_price\nchange = last_price - prev_price\nchange_pct = (change / prev_price) * 100 if prev_price != 0 else 0\n\nst.markdown("---")\nst.markdown(f"### ğŸ’¡ {selected_company} ì£¼ìš” ì§€í‘œ í•œëˆˆì— ë³´ê¸°")\n\nm1, m2, m3, m4, m5, m6 = st.columns(6)  # ì»¬ëŸ¼ ì¶”ê°€ ë° ì„¤ëª… ë‚´ìš© ìˆ˜ì •\nm1.metric("í˜„ì¬ ì£¼ê°€", f"{last_price:,.0f}ì›", f"{change:,.0f}ì› ({change_pct:.2f}%)")\nm2.metric("PER", f"{company_info.get(\'PER(ë°°)\', 0):.2f}ë°°", help="ì£¼ê°€ìˆ˜ìµë¹„ìœ¨(ì£¼ê°€ ëŒ€ë¹„ ê¸°ì—…ì˜ ìˆœì´ìµì„ ë¹„êµí•˜ì—¬ ê¸°ì—…ì˜ ê°€ì¹˜ë¥¼ í‰ê°€, ë‚®ì„ìˆ˜ë¡ ì €í‰ê°€")\nm3.metric("PBR", f"{company_info.get(\'PBR(ë°°)\', 0):.2f}ë°°", help="ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨ (ì£¼ê°€ê°€ ê¸°ì—…ì˜ ìˆœìì‚° ê°€ì¹˜ ëŒ€ë¹„ ì–¼ë§ˆë‚˜ ë†’ê³  ë‚®ì€ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ, ë‚®ì„ìˆ˜ë¡ ì €í‰ê°€)")\nm4.metric("ROE", f"{company_info.get(\'ROE(%)\', 0):.2f}%", help="ìê¸°ìë³¸ì´ìµë¥  (ìê¸°ìë³¸ì„ í™œìš©í•´ 1ë…„ê°„ ì–¼ë§ˆë‚˜ ë²Œì—¬ ë“¤ì˜€ëŠ”ê°€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ, ë†’ì„ìˆ˜ë¡ ìš°")\nm5.metric("ë§¤ì¶œì•¡ ì¦ê°€ìœ¨", f"{company_info.get(\'ë§¤ì¶œì•¡ì¦ê°€ìœ¨\', 0):.2f}%", help="ê¸°ì—…ì˜ ì¼ì • ê¸°ê°„ ë§¤ì¶œì•¡ì´ ì „ë…„ ëŒ€ë¹„ ì–¼ë§ˆë‚˜ ëŠ˜ì—ˆëŠ”ì§€ë¥¼ ë°±ë¶„ìœ¨ë¡œ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ, ê¸°ì—…ì˜ ì„±ì¥ì„±ì„ íŒë‹¨")\nm6.metric("ë¶€ì±„ë¹„ìœ¨", f"{company_info.get(\'ë¶€ì±„ë¹„ìœ¨\', 0):.2f}%", help="ê¸°ì—…ì´ íƒ€ì¸ ìë³¸(ë¶€ì±„)ì— ì–¼ë§ˆë‚˜ ì˜ì¡´í•˜ê³  ìˆëŠ”ì§€ë¥¼ ë°±ë¶„ìœ¨ë¡œ ë‚˜íƒ€ë‚´ëŠ” ì§€í‘œ, ì¼ë°˜ì ìœ¼ë¡œ 100% ì´í•˜ê°€ í‘œì¤€")\nst.markdown("---")\n\n# -----------------------------------------------------------------------------\n# 7. íƒ­ êµ¬ì„±\n# -----------------------------------------------------------------------------\ntab1, tab2 = st.tabs(["ğŸ’ ê¸°ë³¸ì  ë¶„ì„ (Fundamental)", "ğŸ“Š ê¸°ìˆ ì  ë¶„ì„ (Technical)"])  # ë¬¸êµ¬ ìˆ˜ì •\n\n# =============================================================================\n# [TAB 1] ê°€ì¹˜íˆ¬ì - ê°€ì¹˜ ê¸°ë°˜ í€ë”ë©˜í„¸ ë¶„ì„\n# =============================================================================\nwith tab1:\n    st.subheader("ğŸ’ ë‚´ì¬ ê°€ì¹˜ ê¸°ë°˜ì˜ ì¢…ëª© í‰ê°€ ë¶„ì„")\n\n    # (ì ìˆ˜ ì»¬ëŸ¼ & ì›ë³¸ ê°’ ë§¤í•‘)\n     # í‰ê°€í•­ëª© ë¬¸êµ¬ ìˆ˜ì •\n    score_map = {                                 \n        \'ìˆ˜ìµì„±\': (\'ROE(%)_ì ìˆ˜\', \'ROE(%)\'),\n        \'ì„±ì¥ì„±\': (\'ë§¤ì¶œì•¡ì¦ê°€ìœ¨_ì ìˆ˜\', \'ë§¤ì¶œì•¡ì¦ê°€ìœ¨\'),\n        \'ë°°ë‹¹ ì •ë„\': (\'ë°°ë‹¹ìˆ˜ìµë¥ _ì ìˆ˜\', \'ë°°ë‹¹ìˆ˜ìµë¥ \'),\n        \'ì €í‰ê°€ ì •ë„\': (\'PER(ë°°)_ì ìˆ˜\', \'PER(ë°°)\'),\n        \'ì•ˆì •ì„±\': (\'ë¶€ì±„ë¹„ìœ¨_ì ìˆ˜\', \'ë¶€ì±„ë¹„ìœ¨\')\n    }\n\n    labels = list(score_map.keys())\n    my_scores = [company_info.get(score_map[l][0], 0) for l in labels]\n    avg_scores = [market_mean_series.get(score_map[l][0], 0) for l in labels]\n\n    # ë ˆì´ë” ì°¨íŠ¸ìš© ë°ì´í„° ë‹«ê¸°\n    r_me = my_scores + [my_scores[0]]\n    r_avg = avg_scores + [avg_scores[0]]\n    theta = labels + [labels[0]]\n\n    fig = go.Figure()\n\n    # ì‹œì¥ í‰ê· \n    fig.add_trace(go.Scatterpolar(\n        r=r_avg,\n        theta=theta,\n        fill=\'toself\',\n        name=\'ì‹œì¥ í‰ê·  ì ìˆ˜\',\n        line_color=\'gray\',\n        fillcolor=\'rgba(128, 128, 128, 0.3)\',\n        mode=\'lines\'\n    ))\n\n    # ë‚´ ì¢…ëª©\n    fig.add_trace(go.Scatterpolar(\n        r=r_me,\n        theta=theta,\n        fill=\'toself\',\n        name=f\'{selected_company} ì ìˆ˜\',\n        line_color=\'#2980b9\',\n        fillcolor=\'rgba(41, 128, 185, 0.4)\',\n        mode=\'lines+markers\'\n    ))\n\n    fig.update_layout(\n        polar=dict(\n            radialaxis=dict(\n                visible=True,\n                range=[0, 10],\n                tickfont=dict(size=11)\n            ),\n            angularaxis=dict(\n                tickfont=dict(size=14),  # ë°©ì‚¬í˜• ì°¨íŠ¸ ë‚´ í‰ê°€í•­ëª© ê¸€ê¼´ í¬ê¸° ì¡°ì •\n                rotation=90   # ë°©ì‚¬í˜• ì°¨íŠ¸ ê¼­ì§€ì  ìœ„ì¹˜ ì¡°ì •\n            )\n        ),\n        showlegend=True,\n        height=500,\n        title=dict(\n            text=f"ğŸ“Š {selected_company} íˆ¬ì ë§¤ë ¥ë„ (10ì  ë§Œì )",\n            x=0.45,           # íƒ€ì´í‹€ ìœ„ì¹˜ ì¡°ì • ì¶”ê°€\n            xanchor="center"  # íƒ€ì´í‹€ ê°€ìš´ë° ì •ë ¬\n        )\n    )\n\n\n    \n    st.plotly_chart(fig, use_container_width=True)\n\n    # ìƒì„¸ ë¶„ì„\n    st.divider()\n    st.markdown("#### ğŸ“ ì§€í‘œë³„ ìƒì„¸ ì§„ë‹¨")  # ë¬¸êµ¬ ìˆ˜ì •\n    st.info("ğŸ’¡ ì ìˆ˜ëŠ” 0ì ì—ì„œ 10ì ê¹Œì§€ ë¯¸ë¦¬ ì‚°ì •ë˜ì—ˆìœ¼ë©°, íšŒìƒ‰ ì˜ì—­ì€ ëŒ€ìƒ ì¢…ëª©ì˜ ì „ì²´ í‰ê· ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.")  # ë¬¸êµ¬ ìˆ˜ì •\n\n    positive_count = 0\n\n    for label in labels:\n        score_col, raw_col = score_map[label]\n        \n        my_s = company_info.get(score_col, 0)\n        avg_s = market_mean_series.get(score_col, 0)\n        my_raw = company_info.get(raw_col, 0)\n\n        if my_s >= avg_s:\n            status = "**ìš°ìˆ˜ (í‰ê·  ì´ìƒ)**"\n            icon = "âœ…"\n            positive_count += 1\n        else:\n            status = "ë¯¸í¡ (í‰ê·  ë¯¸ë§Œ)"\n            icon = "ğŸ”»"\n\n        st.markdown(\n            f"- {icon} **{label}** : **{my_s:.1f}ì ** (í‰ê·  {avg_s:.1f}ì  ëŒ€ë¹„)\\n"\n            f"    - (ì‹¤ì œê°’: {my_raw:,.2f}) â†’ **{status}**"\n        )\n\n    st.markdown("<br>", unsafe_allow_html=True)\n\n    if positive_count >= 3:\n        st.success(f"ğŸŒŸ **ì¶”ì²œ ì—¬ë¶€** : **{positive_count}ê°œ** ì§€í‘œê°€ í‰ê·  ì´ìƒ â†’ **ì¶”ì²œ**")\n    else:\n        st.warning(f"âš ï¸ **ì¶”ì²œ ì—¬ë¶€** : **{positive_count}ê°œ** ì§€í‘œë§Œ í‰ê·  ì´ìƒ â†’ **ë¹„ì¶”ì²œ**")\n\n# =============================================================================\n# [TAB 2] ê¸°ìˆ íˆ¬ì (í¬ë¡œìŠ¤ & ì¶”ì„¸)\n# =============================================================================\nwith tab2:\n    st.subheader("ğŸ“ˆ ì°¨íŠ¸ & ì¶”ì„¸ ë¶„ì„")\n    \n    # 1. ë¶„ì„ìš© ë°ì´í„° ì¤€ë¹„\n    view_data = company_money.copy()\n    \n    # 2. í¬ë¡œìŠ¤ ì´ë²¤íŠ¸ ê³„ì‚°ì„ ìœ„í•œ ì´ì „ ê°’(Shift) ìƒì„±\n    view_data[\'Prev_MA5\'] = view_data[\'MA5\'].shift(1)\n    view_data[\'Prev_MA20\'] = view_data[\'MA20\'].shift(1)\n    view_data[\'Prev_MA60\'] = view_data[\'MA60\'].shift(1)\n    \n    cross_events = []\n\n    # 3. ì°¨íŠ¸ ê·¸ë¦¬ê¸°\n    fig = go.Figure()\n    \n    # ìº”ë“¤(ì—°í•˜ê²Œ)\n    fig.add_trace(go.Candlestick(\n        x=view_data[\'ë‚ ì§œ\'], \n        open=view_data[\'ì‹œê°€\'], high=view_data[\'ê³ ê°€\'],\n        low=view_data[\'ì €ê°€\'], close=view_data[\'ì¢…ê°€\'], \n        name=\'ì£¼ê°€\',\n        increasing_line_color=\'rgba(255, 0, 0, 0.4)\',\n        increasing_fillcolor=\'rgba(255, 0, 0, 0.4)\',\n        decreasing_line_color=\'rgba(0, 0, 255, 0.4)\',\n        decreasing_fillcolor=\'rgba(0, 0, 255, 0.4)\'\n    ))\n    \n    # ì´í‰ì„ \n    fig.add_trace(go.Scatter(\n        x=view_data[\'ë‚ ì§œ\'], y=view_data[\'MA5\'], \n        line=dict(color=\'mediumblue\', width=1.5), \n        name=\'5ì¼ì„ \'\n    ))\n    fig.add_trace(go.Scatter(\n        x=view_data[\'ë‚ ì§œ\'], y=view_data[\'MA20\'], \n        line=dict(color=\'magenta\', width=1.5), \n        name=\'20ì¼ì„ \'\n    ))\n    fig.add_trace(go.Scatter(\n        x=view_data[\'ë‚ ì§œ\'], y=view_data[\'MA60\'], \n        line=dict(color=\'green\', width=2), \n        name=\'60ì¼ì„  (ê¸°ì¤€)\'\n    ))\n    \n    # 4. ê³¨ë“ /ë°ë“œ í¬ë¡œìŠ¤ íƒì§€\n    for idx, row in view_data.iterrows():\n        if pd.isna(row[\'MA60\']) or pd.isna(row[\'Prev_MA60\']):\n            continue\n\n        is_g5 = (row[\'MA5\'] > row[\'MA60\']) and (row[\'Prev_MA5\'] <= row[\'Prev_MA60\'])\n        is_g20 = (row[\'MA20\'] > row[\'MA60\']) and (row[\'Prev_MA20\'] <= row[\'Prev_MA60\'])\n        \n        is_d5 = (row[\'MA5\'] < row[\'MA60\']) and (row[\'Prev_MA5\'] >= row[\'Prev_MA60\'])\n        is_d20 = (row[\'MA20\'] < row[\'MA60\']) and (row[\'Prev_MA20\'] >= row[\'Prev_MA60\'])\n\n        date_str = row[\'ë‚ ì§œ\'].strftime(\'%Y-%m-%d\')\n        cross_point = row[\'MA60\'] \n\n        if is_g5 or is_g20:\n            fig.add_annotation(\n                x=row[\'ë‚ ì§œ\'], y=cross_point,\n                text="<b>ğŸ’°</b>",\n                font=dict(size=15, color="red"),\n                showarrow=True, \n                arrowhead=2, \n                arrowcolor="rgba(0,0,0,0.4)",\n                arrowwidth=1.5,\n                ax=0, ay=-60\n            )\n            cross_events.append(f"ğŸ”´ **ê³¨ë“ í¬ë¡œìŠ¤ (ë§¤ìˆ˜)**: {date_str}")\n\n        if is_d5 or is_d20:\n            fig.add_annotation(\n                x=row[\'ë‚ ì§œ\'], y=cross_point,\n                text="<b>ğŸ’¸</b>",\n                font=dict(size=15, color="blue"),\n                showarrow=True, \n                arrowhead=2, \n                arrowcolor="rgba(0,0,0,0.4)",\n                arrowwidth=1.5,\n                ax=0, ay=60\n            )\n            cross_events.append(f"ğŸ”µ **ë°ë“œí¬ë¡œìŠ¤ (ë§¤ë„)**: {date_str}")\n    \n    fig.update_layout(\n        title=f"{selected_company} ì¼ë´‰ ì°¨íŠ¸", \n        xaxis_rangeslider_visible=False,\n        height=600,\n        plot_bgcolor=\'rgba(0,0,0,0)\',\n        hovermode="x unified"\n    )\n    st.plotly_chart(fig, use_container_width=True)\n    \n    # 5. í•˜ë‹¨ ì •ë³´ íŒ¨ë„\n    c1, c2 = st.columns(2)\n    with c1:\n        st.markdown("#### ğŸ”” ìµœê·¼ ë§¤ë§¤ ì‹ í˜¸")\n        if cross_events:\n            for e in reversed(cross_events[-5:]):\n                st.markdown(e)\n        else:\n            st.info("ìµœê·¼ ì¡°íšŒ ê¸°ê°„ ë‚´ íŠ¹ì´ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.")\n        \n    with c2:\n        st.markdown("#### ğŸ” ì¶”ì„¸ ìŠ¤ìº” ê²°ê³¼")\n        last = view_data.iloc[-1]\n        \n        if pd.isna(last[\'MA5\']) or pd.isna(last[\'MA60\']):\n            st.write("ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ íŒë‹¨ ë¶ˆê°€")\n        elif last[\'MA5\'] > last[\'MA60\']:\n            st.success("ğŸ“ˆ í˜„ì¬ **\'ìƒìŠ¹ ì¶”ì„¸\'** êµ¬ê°„ì…ë‹ˆë‹¤.")\n        else:\n            st.error("ğŸ“‰ í˜„ì¬ **\'í•˜ë½ ì¶”ì„¸\'** êµ¬ê°„ì…ë‹ˆë‹¤.")\n')


# In[ ]:




